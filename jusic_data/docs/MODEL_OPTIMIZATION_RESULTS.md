# 📊 주식 예측 모델 최적화 결과 보고서

## 📋 실험 개요

**목적**: 거시경제 데이터와 pykrx 투자자 거래 데이터를 추가하여 모델 성능 개선

**실험 기간**: 2025-10-29

**실험 모델**:
- Direction (방향성): 5일 후 주가 상승/하락 예측
- Volatility (변동성): 5일 후 변동성 높음/낮음 예측
- Risk (위험도): 5일 후 5% 이상 손실 위험 예측

---

## 🔬 실험 과정

### 1단계: 데이터 수집
- ✅ 거시경제 데이터: KOSPI, USD/KRW, VIX, S&P 500 (6년치)
- ✅ pykrx 데이터: 30개 종목 투자자 거래 데이터 (6년치)
- ✅ 캐싱 시스템 구축 (빠른 재사용)

### 2단계: 베이스라인 모델 학습
- 30개 전체 종목 사용 (기존 16개 필터링 제거)
- 기술지표만 사용

### 3단계: 특징 추가 실험
1. **거시경제만 추가**
2. **pykrx만 추가**
3. **거시경제 + pykrx 결합**
4. **모든 모델에 pykrx 추가**

---

## 📊 실험 결과

### Direction 모델 (가장 중요)

| 설정 | 특징 수 | Val Accuracy | 개선폭 | 순위 |
|------|---------|--------------|--------|------|
| 베이스라인 (기술지표만) | 8 | 0.5435 | baseline | 3위 |
| + 거시경제만 | 13 | **0.5676** | **+2.41%p** | **🥇 1위** |
| + pykrx만 | 11 | 0.5400 | -0.35%p | 4위 |
| + 거시경제 + pykrx | 16 | 0.5668 | +2.32%p | 2위 |

**결론**: 
- ✅ **거시경제만 추가가 최적** (+2.41%p)
- ❌ pykrx 추가 시 오히려 성능 하락 (-0.08%p)

### Volatility 모델

| 설정 | 특징 수 | Val Accuracy | 개선폭 |
|------|---------|--------------|--------|
| 원래 모델 | 5 | 0.6607 | baseline |
| + pykrx 추가 | 8 | **0.6677** | **+0.70%p** |

**결론**: 
- ✅ **pykrx 추가가 효과적** (+0.70%p)
- 외국인/기관 매수가 변동성 안정화에 기여

### Risk 모델

| 설정 | 특징 수 | Val Accuracy | 개선폭 |
|------|---------|--------------|--------|
| 원래 모델 | 16 | **0.5988** | baseline |
| + pykrx 추가 | 19 | 0.5781 | -2.08%p |

**결론**: 
- ❌ pykrx 추가 시 성능 하락
- ✅ **원래 모델 유지**

---

## 🎯 최종 최적 모델 구성

```
Direction 모델 (13 features):
  - 8개 기술지표 + 5개 거시경제
  - Val Accuracy: 0.5676 (+2.41%p)
  - 특징: MA_Ratio, RSI, Price_Change, Volume_Ratio, Volatility, 
          MACD, BB_Position, Momentum_5, 
          KOSPI_Change, USD_KRW_Change, VIX, VIX_Change, SP500_Change

Volatility 모델 (8 features):
  - 5개 기술지표 + 3개 pykrx
  - Val Accuracy: 0.6677 (+0.70%p)
  - 특징: MA_Ratio, RSI, Price_Change, Volume_Ratio, Volatility,
          Institution_Ratio, Foreign_Ratio, Individual_Ratio

Risk 모델 (16 features):
  - 16개 기술지표 (원래 모델)
  - Val Accuracy: 0.6010
  - 특징: MA_Ratio, RSI, Price_Change, Volume_Ratio, Volatility,
          MACD, BB_Position, Momentum_5, RSI_x_Volume, Trend_Strength,
          BB_Momentum, Volatility_x_RSI, MACD_x_Volume, Price_Momentum,
          RSI_MACD, BB_Volatility
```

---

## 💡 주요 발견 사항

### 1. 거시경제 데이터의 효과

**✅ Direction 모델에 매우 효과적**
- +2.41%p 성능 향상
- 과적합 대폭 감소: 0.0793 → 0.0104
- 시장 전체 흐름이 개별 주식 방향 예측에 도움

**왜 작동하는가?**
- VIX, KOSPI: 시장 심리 반영
- USD/KRW, S&P 500: 글로벌 경제 흐름
- 선행 지표로 작용 가능

### 2. pykrx 투자자 거래 데이터의 효과

**❌ Direction 모델에는 역효과**
- -0.35%p 성능 하락
- 이유: **후행 지표** (주가 오른 후 매수)

**분석 결과:**
```
외국인 강한 매수일:
  당일 수익률:  +1.38%p 차이 ✅ (사실!)
  다음날:       -0.04%p 차이 (없음)
  5일 후:       +0.04%p 차이 (거의 없음)

→ 인과관계: 주가 상승 → 외국인 매수 (역순!)
→ 이미 가격에 반영됨 (효율적 시장)
```

**✅ Volatility 모델에는 효과적**
- +0.70%p 성능 향상
- 외국인/기관 매수 → 변동성 안정화
- 개인 투자 증가 → 변동성 증가

**❌ Risk 모델에는 역효과**
- -2.08%p 성능 하락
- 단기 위험 예측에 무관

### 3. 거시경제 + pykrx 결합 효과

**Direction 모델:**
- 거시경제만: 0.5676 (BEST)
- 거시경제 + pykrx: 0.5668 (-0.08%p)
- **pykrx가 노이즈로 작용**

---

## 📈 성능 비교

### 원래 모델 (16개 종목) vs 최종 모델 (30개 종목)

```
원래 모델:
  Direction:  0.5626
  Volatility: 0.6681
  Risk:       0.6589

최종 모델:
  Direction:  0.5676 (+0.49%p) ✅
  Volatility: 0.6677 (+0.70%p) ✅ (pykrx 효과)
  Risk:       0.6010 (-5.79%p)
```

**Risk 모델 하락 이유:**
- 16개 → 30개 종목 확장으로 일반화
- 특정 가격대(저렴한 주식)에 과적합되어 있었음
- 더 넓은 범위에서 일반화된 모델로 개선

---

## 🎯 최종 권장사항

### ✅ 채택된 설정
```
Direction:  거시경제 추가 (13 features)
Volatility: pykrx 추가 (8 features)
Risk:       원래 모델 (16 features)
30개 전체 종목 사용
```

### 📁 저장된 파일
- `final_hybrid_optimal_models.pkl`: 최종 최적화 모델
- `pykrx_data_30stocks_cache.pkl`: pykrx 30개 종목 캐시
- `cached_data/macro_data.pkl`: 거시경제 데이터 캐시

---

## 🚀 다음 단계: 감정분석

### 감정분석 통합 계획

#### 데이터 소스 옵션
1. **뉴스 기사** (추천)
   - 네이버 뉴스
   - 한국경제, 매일경제, 서울경제
   - 종목별 뉴스 크롤링

2. **소셜 미디어**
   - 네이버 카페, 주식 커뮤니티
   - X (Twitter) - 한정적

3. **증권사 리포트**
   - PDF 분석 복잡도 높음

#### 감정분석 방법
1. **간단한 방법** (빠른 프로토타입)
   - 긍정/부정 키워드 사전
   - 빠르고 구현 쉬움

2. **고급 방법** (높은 정확도)
   - KoBERT, KoELECTRA
   - Transformers 기반
   - 사전학습 모델 활용

#### 특징 생성
```
감정 점수 (Sentiment Score):
  - 긍정 뉴스 비율 (최근 1주일)
  - 부정 뉴스 비율
  - 감정 점수 변화율
  - 뉴스 볼륨 (언급량)
```

---

## 📝 구현 난이도 평가

### Option A: 간단한 키워드 기반 (추천)
- ⏱️ 구현 시간: 1-2시간
- 🎯 난이도: 낮음
- 📊 예상 효과: 중간

### Option B: KoBERT 감정분석
- ⏱️ 구현 시간: 3-5시간
- 🎯 난이도: 중간
- 📊 예상 효과: 높음
- ⚠️ 추가 패키지 필요: transformers, torch

### Option C: 증권사 리포트 분석
- ⏱️ 구현 시간: 5-10시간
- 🎯 난이도: 높음
- 📊 예상 효과: 매우 높음
- ⚠️ PDF 파싱, OCR 필요

---

**어떤 방법으로 진행하시겠습니까?**

1️⃣ 간단한 키워드 기반 (빠른 프로토타입)  
2️⃣ KoBERT 감정분석 (고급)  
3️⃣ 증권사 리포트 분석 (최고급)

